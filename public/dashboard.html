<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard | Imarika</title>
<link rel="icon" href="/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#fff; --text:#0f172a; --muted:#475569; --line:#e5e7eb; --card:#fff;
         --brand:#f59e0b; --ok:#16a34a; --danger:#ef4444; --ring:rgba(245,158,11,.35) }
  *{box-sizing:border-box}
  html,body{margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; overflow-x:hidden}
  a{text-decoration:none;color:inherit}
  .container{max-width:1120px;margin:0 auto;padding:0 1rem}
  @media (max-width:560px){ .container{padding:0 .75rem} }

  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:40}
  .brand{display:flex;align-items:center;gap:.55rem;height:64px}
  .logo{height:32px;width:32px;border-radius:10px}

  .btn{display:inline-flex;align-items:center;justify-content:center;padding:.72rem 1rem;border-radius:14px;font-weight:700;background:var(--brand);color:#111827;border:0;cursor:pointer;box-shadow:0 10px 30px rgba(245,158,11,.25)}
  .btn-outline{background:#fff;border:1px solid var(--line)}
  .btn-slim{padding:.55rem .75rem;border-radius:12px}
  @media (max-width:560px){
    .btn, .btn-outline, .btn-slim{width:100%}
  }

  .grid{display:grid;gap:1rem}
  .grid2{grid-template-columns:1fr}
  @media(min-width:768px){.grid2{grid-template-columns:2fr 1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:1.15rem;box-shadow:0 10px 30px rgba(2,8,23,.06)}
  @media (max-width:560px){ .card{padding:.9rem} }

  input,select,textarea{width:100%;padding:.85rem;border:1px solid var(--line);border-radius:14px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:#cbd5e1;box-shadow:0 0 0 4px var(--ring)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .badge{padding:.18rem .5rem;border-radius:999px;background:#fef3c7;color:#78350f;font-weight:800}

  /* Tables default */
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border:1px solid var(--line);padding:.6rem .7rem;vertical-align:top}
  .table th{background:#fff7ed}

  /* Mobile table → card list */
  @media (max-width:560px){
    .table{border-collapse:separate;border-spacing:0}
    .table thead{display:none}
    .table tr{display:block;border:1px solid var(--line);border-radius:12px;margin:.5rem 0;background:#fff}
    .table td{display:flex;gap:.75rem;justify-content:space-between;border:none;border-bottom:1px solid var(--line);padding:.6rem .75rem}
    .table td:last-child{border-bottom:none}
    .table td::before{content:attr(data-label);font-weight:700;color:var(--muted)}
  }

  /* Mobile: pin Logout to top-right corner */
  @media (max-width:640px){
    #logoutBtn{
      position:fixed;
      top:calc(env(safe-area-inset-top, 0px) + 8px);
      right:calc(env(safe-area-inset-right, 0px) + 8px);
      z-index:90;
      padding:.5rem .75rem;
      border-radius:999px;
      white-space:nowrap;
      box-shadow:0 8px 22px rgba(2,8,23,.15);
      backdrop-filter:blur(6px);
    }
  }

  /* Smaller heading on phones */
  @media (max-width:560px){ h1{font-size:1.35rem;margin: .9rem 0 .2rem} }
</style>

<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between">
      <a class="brand" href="/"><img src="/favicon.svg" class="logo" alt=""><strong>Imarika</strong></a>
      <div style="display:flex;gap:.6rem">
        <button class="btn btn-outline" id="logoutBtn" title="Sign out">Logout</button>
      </div>
    </div>
  </header>

  <section>
    <div class="container">
      <h1>Dashboard</h1>
      <div class="muted" id="who"></div>

      <div id="dash" class="grid grid2" style="margin-top:1rem;display:none">
        <div class="grid">
          <!-- WALLET CARD -->
          <div class="card">
            <div id="stamp" class="muted mono" style="font-size:.85rem;margin-bottom:.25rem"></div>
            <div style="display:flex;align-items:end;justify-content:space-between;gap:.8rem;flex-wrap:wrap">
              <div>
                <div style="font-weight:800">Wallet Balance</div>
                <div class="muted">Available to invest/withdraw</div>
              </div>
              <div style="text-align:right">
                <div id="wallet" style="font-weight:800;font-size:1.6rem;line-height:1">KES 0</div>
              </div>
            </div>

            <div class="btn-row" style="margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap">
              <a class="btn btn-slim" href="/deposit.html">Deposit</a>
              <button class="btn btn-outline btn-slim" id="showWithdraw">Withdraw</button>
            </div>
          </div>

          <!-- SHARES CARD -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap">
              <div>
                <strong>Investments (Shares)</strong>
                <div class="muted">Active amount in plans</div>
              </div>
              <div style="font-weight:800" id="shares">KES 0</div>
            </div>
          </div>

          <!-- WITHDRAW CARD -->
          <div class="card" id="withdrawCard" style="display:none">
            <strong>Withdraw to M-Pesa</strong>
            <div style="display:grid;gap:.6rem;margin-top:.6rem">
              <input id="wPhone" inputmode="tel" placeholder="M-Pesa number (07/01… 10 digits)">
              <input id="wAmt" type="number" placeholder="Amount (KES)">
              <button class="btn btn-slim" id="doWithdraw">Request Withdraw</button>
              <div class="muted" id="wHint"></div>
            </div>
          </div>

          <!-- TRANSACTIONS -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
              <strong>Transactions — Investments & Wallet</strong>
              <span class="badge" id="txCount">0</span>
            </div>
            <div style="overflow:auto;margin-top:.6rem">
              <table class="table" id="txTable">
                <thead>
                  <tr>
                    <th>Date</th><th>Type</th><th>Details</th><th style="text-align:right">Amount (KES)</th><th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted" style="text-align:center">No transactions yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- RIGHT SIDEBAR -->
        <div class="grid">
          <div class="card">
            <strong>Quick Calculator</strong>
            <div class="muted">Preview 24h payout & start</div>
            <div style="display:grid;gap:.6rem;margin-top:.6rem">
              <select id="plan">
                <option value="std">Standard (30%)</option>
                <option value="gold">Gold (50%)</option>
                <option value="plat">Platinum (70%)</option>
              </select>
              <input id="amt" type="number" min="1000" placeholder="Enter amount">
              <button class="btn btn-slim" id="calc">Calculate</button>
              <div class="muted" id="out"></div>
              <a class="btn btn-slim" id="startBtn" href="/deposit.html">Start & Deposit</a>
            </div>
          </div>

          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
              <strong>Loan History</strong>
              <span class="badge" id="loanCount">0</span>
            </div>
            <div style="overflow:auto;margin-top:.6rem">
              <table class="table" id="loanTable">
                <thead>
                  <tr>
                    <th>Date</th><th>Product</th><th>Tenor</th><th style="text-align:right">Amount (KES)</th><th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted" style="text-align:center">No loan activity yet.</td></tr>
                </tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:.6rem">
              Need a working-capital loan? <a href="https://wa.me/254701017246?text=Hello%20Imarika%2C%20I%20want%20a%20working-capital%20loan." target="_blank">Request on WhatsApp</a>.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // ===== Helpers / Storage =====
    const fmt = n => Number(n).toLocaleString('en-KE');
    const phoneOk = p => /^0(7|1)\d{8}$/.test(String(p||'').trim());
    const saveUser = u => localStorage.setItem('imarika_user', JSON.stringify(u));
    const getUser  = () => { try { return JSON.parse(localStorage.getItem('imarika_user')||'null'); } catch { return null; } };

    const TX_KEY='imarika_tx', LOAN_KEY='imarika_loan_tx';
    const getTx = () => { try { return JSON.parse(localStorage.getItem(TX_KEY)||'[]'); } catch { return []; } };
    const saveTx = list => localStorage.setItem(TX_KEY, JSON.stringify(list));
    const addTx = tx => { const list=getTx(); list.unshift(tx); saveTx(list); renderTx(); };
    const getLoans = () => { try { return JSON.parse(localStorage.getItem(LOAN_KEY)||'[]'); } catch { return []; } };
    const saveLoans = list => localStorage.setItem(LOAN_KEY, JSON.stringify(list));
    const addLoan = loan => { const list=getLoans(); list.unshift(loan); saveLoans(list); renderLoans(); };

    // ===== UI refs =====
    const dash = document.getElementById('dash'), who = document.getElementById('who');
    const walletEl = document.getElementById('wallet'), sharesEl = document.getElementById('shares'), stamp = document.getElementById('stamp');
    const txBody = document.getElementById('txTable').querySelector('tbody'), txCount = document.getElementById('txCount');
    const loanBody = document.getElementById('loanTable').querySelector('tbody'), loanCount = document.getElementById('loanCount');

    function show(u){
      who.innerHTML = `<span class="muted">Acct:</span> <span class="mono"><strong>${u.account}</strong></span> • ${u.full||''}`;
      walletEl.textContent = 'KES ' + fmt(u.wallet||0);
      sharesEl.textContent = 'KES ' + fmt(u.invested||0);
      stamp.textContent = 'Updated ' + new Date().toLocaleString();
      dash.style.display='grid';
      renderTx(); renderLoans();
    }

    function renderTx(){
      const list = getTx();
      txCount.textContent = list.length;
      txBody.innerHTML = list.length ? list.map(t => `
        <tr>
          <td class="mono" data-label="Date">${new Date(t.ts).toLocaleString()}</td>
          <td data-label="Type">${t.type}</td>
          <td data-label="Details">${t.detail||'-'}</td>
          <td data-label="Amount (KES)" style="text-align:right">${fmt(t.amount||0)}</td>
          <td data-label="Status">${t.status||'-'}</td>
        </tr>
      `).join('') : `<tr><td colspan="5" class="muted" style="text-align:center">No transactions yet.</td></tr>`;
    }
    function renderLoans(){
      const list = getLoans();
      loanCount.textContent = list.length;
      loanBody.innerHTML = list.length ? list.map(t => `
        <tr>
          <td class="mono" data-label="Date">${new Date(t.ts).toLocaleString()}</td>
          <td data-label="Product">${t.product||'-'}</td>
          <td data-label="Tenor">${t.tenor||'-'}</td>
          <td data-label="Amount (KES)" style="text-align:right">${fmt(t.amount||0)}</td>
          <td data-label="Status">${t.status||'-'}</td>
        </tr>
      `).join('') : `<tr><td colspan="5" class="muted" style="text-align:center">No loan activity yet.</td></tr>`;
    }

    // ===== Withdraw (enforces wallet balance) =====
    document.getElementById('showWithdraw').onclick = ()=>{
      const c = document.getElementById('withdrawCard');
      c.style.display = c.style.display==='none' ? 'block' : 'none';
    };
    document.getElementById('doWithdraw').onclick = ()=>{
      const p = wPhone.value.trim(), a = Number(wAmt.value||0), h = wHint;
      let u = getUser() || {wallet:0};
      if(!phoneOk(p)){ h.textContent='Enter a valid M-Pesa number.'; return; }
      if(a<=0){ h.textContent='Enter amount.'; return; }
      if(a > (u.wallet||0)){ h.textContent='Insufficient wallet balance.'; return; }

      u.wallet = (u.wallet||0) - a; saveUser(u); show(u);
      addTx({ ts:Date.now(), type:'Withdrawal', detail:`To ${p}`, amount:-Math.abs(a), status:'Requested' });
      h.textContent='Withdrawal request submitted.'; wAmt.value='';
    };

    // ===== Calculator with plan limits =====
    const planEl = document.getElementById('plan');
    const amtEl  = document.getElementById('amt');
    const out    = document.getElementById('out');
    const startBtn = document.getElementById('startBtn');

    const PLANS = {
      std:  { name:'Standard',  pct:30, min:1000,   max:70000 },
      gold: { name:'Gold',      pct:50, min:70001,  max:140000 },
      plat: { name:'Platinum',  pct:70, min:140001, max:Infinity }
    };

    function syncPlanUI(){
      const p = PLANS[planEl.value];
      amtEl.min = p.min; isFinite(p.max) ? (amtEl.max = p.max) : amtEl.removeAttribute('max');
      amtEl.placeholder = `Enter amount (${p.min.toLocaleString('en-KE')}${isFinite(p.max)?' – '+p.max.toLocaleString('en-KE'):' and above'})`;
      out.textContent = '';
    }
    planEl.addEventListener('change', syncPlanUI); syncPlanUI();

    function validateAmount(){
      const p = PLANS[planEl.value], amt = Number(amtEl.value||0);
      if(!amt || amt < p.min){ out.textContent = `Minimum for ${p.name} is KES ${p.min.toLocaleString('en-KE')}.`; return null; }
      if(isFinite(p.max) && amt > p.max){ out.textContent = `Maximum for ${p.name} is KES ${p.max.toLocaleString('en-KE')}.`; return null; }
      return {plan:p, amt};
    }

    document.getElementById('calc').onclick = ()=>{
      const v = validateAmount(); if(!v) return;
      const earn = Math.round(v.amt * v.plan.pct / 100);
      out.innerHTML = `Projected earnings in 24h: <strong style="color:var(--ok)">KES ${fmt(earn)}</strong> • Total: <strong>KES ${fmt(v.amt+earn)}</strong>`;
    };

    startBtn.addEventListener('click', (e)=>{
      const v = validateAmount(); if(!v){ e.preventDefault(); return; }
      addTx({ ts:Date.now(), type:'Investment', detail:`${v.plan.name} (${v.plan.pct}% in 24h) — Pending deposit`, amount:v.amt, status:'Pending' });
    });

    // ===== Logout → Home =====
    document.getElementById('logoutBtn').onclick = ()=>{
      localStorage.removeItem('imarika_user');
      window.location.href = '/';
    };

    // ===== Gate: must be logged in =====
    const user = getUser();
    if(!user){ window.location.replace('/account.html'); } else { show(user); }
  </script>
</body>
</html>
