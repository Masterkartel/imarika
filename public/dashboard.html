<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Dashboard | Imarika</title>
<link rel="icon" href="/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--card:#fff;
    --brand:#f59e0b;--ok:#16a34a;--danger:#ef4444;--ring:rgba(245,158,11,.35);
    --tab-h:64px; /* bottom tab height */
    --head-h:56px; /* compact header for phones */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{text-decoration:none;color:inherit}

  /* Header */
  header{position:fixed;top:0;left:0;right:0;height:var(--head-h);
    background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:40}
  .header-inner{max-width:1120px;margin:0 auto;padding:0 .9rem;height:100%;
    display:flex;align-items:center;justify-content:space-between;gap:.6rem}
  .brand{display:flex;align-items:center;gap:.55rem;min-width:0}
  .logo{height:28px;width:28px;border-radius:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:.6rem .9rem;border-radius:12px;font-weight:700;background:var(--brand);color:#111827;border:0;cursor:pointer;box-shadow:0 10px 20px rgba(245,158,11,.18)}
  .btn-outline{background:#fff;border:1px solid var(--line)}
  .btn-slim{padding:.5rem .75rem;border-radius:12px}

  /* App frame */
  .app{position:fixed;inset:var(--head-h) 0 calc(var(--tab-h) + env(safe-area-inset-bottom,0px)) 0; height:calc(100svh - var(--head-h) - var(--tab-h) - env(safe-area-inset-bottom,0px));}
  .screen{height:100%;max-width:1120px;margin:0 auto;padding:.9rem;display:none}
  .screen.active{display:block}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:1rem;box-shadow:0 10px 24px rgba(2,8,23,.06)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .amount{font-weight:800;font-size:1.6rem;line-height:1;text-align:right;overflow-wrap:anywhere;word-break:break-word}

  input,select,textarea{width:100%;padding:.85rem;border:1px solid var(--line);border-radius:14px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:#cbd5e1;box-shadow:0 0 0 4px var(--ring)}

  /* Tables (kept, but trimmed for mobile) */
  .table{width:100%;border-collapse:collapse;font-size:.95rem}
  .table th,.table td{border:1px solid var(--line);padding:.55rem}
  .table th{background:#fff7ed}
  .badge{padding:.18rem .5rem;border-radius:999px;background:#fef3c7;color:#78350f;font-weight:800}

  /* Bottom tabs */
  .tabs{position:fixed;left:0;right:0;bottom:0;height:calc(var(--tab-h) + env(safe-area-inset-bottom,0px));
    padding-bottom:env(safe-area-inset-bottom,0px);
    background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(4,1fr);z-index:50}
  .tab-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:.78rem;color:#475569}
  .tab-btn.active{color:#0f172a;font-weight:700}
  .tab-ico{width:22px;height:22px;display:grid;place-items:center;border-radius:8px;border:1px solid transparent}
  .tab-btn.active .tab-ico{border-color:#fde68a;background:#fffbeb}

  /* Desktop: show dual columns inside each screen */
  @media(min-width:920px){
    .screen-inner{display:grid;grid-template-columns:2fr 1fr;gap:1rem;height:100%}
    .stack{display:grid;gap:1rem;overflow:auto;padding-right:.2rem}
  }

  /* Utility for green strong */
  .ok-strong{color:var(--ok);font-weight:800}

  /* Footer (kept but not used in app frame; hidden on phones) */
  footer{display:none}
  @media(min-width:920px){ footer{display:block;border-top:1px solid var(--line);padding:2rem 0;color:#475569;margin-top:2rem} }
</style>

<body>
  <!-- Header -->
  <header>
    <div class="header-inner">
      <a class="brand" href="/"><img src="/favicon.svg" class="logo" alt=""><strong>Imarika</strong></a>
      <button class="btn btn-outline" id="logoutBtn" title="Sign out">Logout</button>
    </div>
  </header>

  <!-- App screens -->
  <main class="app">
    <!-- Home / Wallet screen -->
    <section id="screen-home" class="screen active" aria-label="Wallet">
      <div class="screen-inner">
        <div class="stack">
          <h1 style="margin:0 0 .25rem">Dashboard</h1>
          <div class="muted" id="who"></div>

          <!-- Wallet -->
          <div class="card">
            <div id="stamp" class="muted mono" style="font-size:.85rem;margin-bottom:.25rem"></div>
            <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:.8rem;flex-wrap:wrap">
              <div>
                <div style="font-weight:800">Wallet Balance</div>
                <div class="muted">Available to invest/withdraw</div>
              </div>
              <div style="text-align:right;min-width:160px">
                <div id="wallet" class="amount">KES 0</div>
              </div>
            </div>

            <div style="margin-top:.8rem;display:flex;gap:.6rem;flex-wrap:wrap">
              <a class="btn btn-slim" href="/deposit.html">Deposit</a>
              <button class="btn btn-outline btn-slim" id="showWithdraw">Withdraw</button>
            </div>
          </div>

          <!-- Shares -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.8rem;flex-wrap:wrap">
              <div>
                <strong>Investments (Shares)</strong>
                <div class="muted">Active amount in plans</div>
              </div>
              <div style="text-align:right;min-width:160px">
                <div id="shares" class="amount" style="font-size:1.4rem">KES 0</div>
              </div>
            </div>
          </div>

          <!-- Withdraw -->
          <div class="card" id="withdrawCard" style="display:none">
            <strong>Withdraw to M-Pesa</strong>
            <div style="display:grid;gap:.6rem;margin-top:.6rem">
              <input id="wPhone" inputmode="tel" placeholder="M-Pesa number (07/01… 10 digits)">
              <input id="wAmt" type="number" placeholder="Amount (KES)">
              <button class="btn btn-slim" id="doWithdraw">Request Withdraw</button>
              <div class="muted" id="wHint"></div>
            </div>
          </div>
        </div>

        <!-- Right column (desktop only visual; on phones each screen is single column) -->
        <div class="stack" aria-hidden="true"></div>
      </div>
    </section>

    <!-- Invest screen -->
    <section id="screen-invest" class="screen" aria-label="Invest">
      <div class="screen-inner">
        <div class="stack">
          <h2 style="margin:0 0 .5rem">Invest</h2>

          <!-- Loan Eligibility (3× Shares) -->
          <div class="card" id="loanEligCard">
            <strong>Loan Eligibility (3× Shares)</strong>
            <div class="muted">Minimum loan: <strong>KES 20,000</strong>. Example: shares <strong>KES 8,000</strong> → qualifies <span class="ok-strong">KES 24,000</span> within 24h; repay over 3 months at 10% interest (~KES <strong>8,800</strong>/month).</div>
            <div style="display:grid;gap:.6rem;margin-top:.6rem">
              <label class="muted" for="eligShares">Your Shares (KES)</label>
              <input id="eligShares" type="number" min="0" placeholder="Enter your current shares">
              <div id="eligOut" class="muted"></div>
              <a class="btn btn-slim" href="/deposit.html">Deposit Shares</a>
            </div>
          </div>

          <!-- Quick Investment Calculator -->
          <div class="card">
            <strong>Quick Calculator</strong>
            <div class="muted">Preview 24h payout & start</div>
            <div style="display:grid;gap:.6rem;margin-top:.6rem">
              <select id="plan">
                <option value="std">Standard (30%)</option>
                <option value="gold">Gold (50%)</option>
                <option value="plat">Platinum (70%)</option>
              </select>
              <input id="amt" type="number" min="1000" placeholder="Enter amount">
              <button class="btn btn-slim" id="calc">Calculate</button>
              <div class="muted" id="out"></div>
              <a class="btn btn-slim" id="startBtn" href="/deposit.html">Start & Deposit</a>
            </div>
          </div>
        </div>

        <div class="stack" aria-hidden="true"></div>
      </div>
    </section>

    <!-- Activity screen -->
    <section id="screen-activity" class="screen" aria-label="Activity">
      <div class="screen-inner">
        <div class="stack">
          <h2 style="margin:0 0 .5rem">Activity</h2>

          <!-- Transactions -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
              <strong>Transactions — Investments & Wallet</strong>
              <span class="badge" id="txCount">0</span>
            </div>
            <div style="overflow:auto;margin-top:.6rem">
              <table class="table" id="txTable">
                <thead>
                  <tr>
                    <th>Date</th><th>Type</th><th>Details</th>
                    <th style="text-align:right">Amount (KES)</th><th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted" style="text-align:center">No transactions yet.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Loan History -->
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap">
              <strong>Loan History</strong>
              <span class="badge" id="loanCount">0</span>
            </div>
            <div style="overflow:auto;margin-top:.6rem">
              <table class="table" id="loanTable">
                <thead>
                  <tr>
                    <th>Date</th><th>Product</th><th>Tenor</th>
                    <th style="text-align:right">Amount (KES)</th><th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted" style="text-align:center">No loan activity yet.</td></tr>
                </tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:.6rem">
              Need a working-capital loan? <a href="https://wa.me/254701017246?text=Hello%20Imarika%2C%20I%20want%20a%20working-capital%20loan." target="_blank">Request on WhatsApp</a>.
            </div>
          </div>
        </div>

        <div class="stack" aria-hidden="true"></div>
      </div>
    </section>

    <!-- Profile / Support (optional space; reusing footer info for desktop only) -->
    <section id="screen-more" class="screen" aria-label="More">
      <div class="screen-inner">
        <div class="stack">
          <h2 style="margin:0 0 .5rem">More</h2>
          <div class="card">
            <p class="muted">For payments we accept:</p>
            <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
              <img src="/mpesa.png" alt="M-Pesa" style="height:50px;width:auto;vertical-align:middle">
              <span class="muted">·</span>
              <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true"><path fill="#334155" d="M3 10.5 12 5l9 5.5v7A1.5 1.5 0 0 1 19.5 19h-15A1.5 1.5 0 0 1 3 17.5z"/><path fill="#94a3b8" d="M12 7.2 5 11v6.5h14V11z"/></svg>
              <strong>Bank Transfer</strong>
            </div>
          </div>
        </div>
        <div class="stack" aria-hidden="true"></div>
      </div>
    </section>
  </main>

  <!-- Bottom Tab Bar -->
  <nav class="tabs" role="tablist" aria-label="Main navigation">
    <button class="tab-btn active" data-target="home" aria-selected="true">
      <span class="tab-ico">🏠</span><span>Home</span>
    </button>
    <button class="tab-btn" data-target="invest" aria-selected="false">
      <span class="tab-ico">📈</span><span>Invest</span>
    </button>
    <button class="tab-btn" data-target="activity" aria-selected="false">
      <span class="tab-ico">🧾</span><span>Activity</span>
    </button>
    <button class="tab-btn" data-target="more" aria-selected="false">
      <span class="tab-ico">⋯</span><span>More</span>
    </button>
  </nav>

  <!-- (Desktop footer retained if needed) -->
  <footer>
    <div class="header-inner" style="height:auto;justify-content:space-between;padding:.9rem 0">
      <div style="display:flex;align-items:center;gap:.6rem">
        <img src="/favicon.svg" class="logo" alt="">
        <span>© <span id="y"></span> Imarika — <a class="muted" href="https://imarika.net">imarika.net</a></span>
      </div>
      <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
        <span class="muted">Payments Accepted:&nbsp;</span>
        <img src="/mpesa.png" alt="M-Pesa" style="height:60px;width:auto;vertical-align:middle">
        <span class="muted">·</span>
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true"><path fill="#334155" d="M3 10.5 12 5l9 5.5v7A1.5 1.5 0 0 1 19.5 19h-15A1.5 1.5 0 0 1 3 17.5z"/><path fill="#94a3b8" d="M12 7.2 5 11v6.5h14V11z"/></svg>
        <strong>Bank Transfer</strong>
      </div>
    </div>
  </footer>

  <script>
    // Footer year
    const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();

    // ===== Helpers / Storage =====
    const fmt = n => Number(n||0).toLocaleString('en-KE');
    const phoneOk = p => /^0(7|1)\d{8}$/.test(String(p||'').trim());
    const saveUser = u => localStorage.setItem('imarika_user', JSON.stringify(u));
    const getUser  = () => { try { return JSON.parse(localStorage.getItem('imarika_user')||'null'); } catch { return null; } };

    // legacy local (kept for migration completeness)
    const TX_KEY='imarika_tx';
    const LOAN_KEY='imarika_loan_tx';
    const getLocalTx = () => { try { return JSON.parse(localStorage.getItem(TX_KEY)||'[]'); } catch { return []; } };
    const clearLocalTx = () => localStorage.removeItem(TX_KEY);

    // ===== UI refs =====
    const who = document.getElementById('who');
    const walletEl = document.getElementById('wallet'), sharesEl = document.getElementById('shares'), stamp = document.getElementById('stamp');
    const txTable = document.getElementById('txTable').querySelector('tbody'), txCount = document.getElementById('txCount');

    function showHeader(u){
      const name = (u.full || u.full_name || '').trim();
      const label = name ? `Acct: <span class="mono"><strong>${u.account}</strong></span> — <strong>${name}</strong>` :
                           `Acct: <span class="mono"><strong>${u.account}</strong></span>`;
      who.innerHTML = label;
      walletEl.textContent = 'KES ' + fmt(u.wallet||0);
      sharesEl.textContent = 'KES ' + fmt(u.invested||0);
      stamp.textContent = 'Updated ' + new Date().toLocaleString();
    }

    // ===== Server helpers =====
    let serverTx = [];

    async function fetchServerTx(){
      const u = getUser(); if(!u) return;
      try{
        const r = await fetch('/api/tx?phone=' + encodeURIComponent(u.phone));
        const j = await r.json().catch(()=>({ok:false}));
        if(j.ok){ serverTx = j.tx || []; renderTx(serverTx); }
      }catch(_){}
    }

    async function fetchUser(){
      const u = getUser(); if(!u) return;
      try{
        const r = await fetch('/api/user?phone=' + encodeURIComponent(u.phone));
        const j = await r.json().catch(()=>({ok:false}));
        if(j.ok && j.user){
          // Merge fresh server fields into local user
          saveUser({ ...u, ...j.user });
          showHeader(getUser());
          // Prefill eligibility shares if field exists
          const es = document.getElementById('eligShares');
          if (es && typeof j.user.invested !== 'undefined') {
            es.value = Number(j.user.invested||0);
            computeEligibility();
          }
        }
      }catch(_){}
    }

    async function createServerTx(row){
      try{
        const r = await fetch('/api/tx', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify(row)
        });
        const j = await r.json().catch(()=>({ok:false}));
        if(j.ok){
          await fetchServerTx();
          await fetchUser();
        }
        return !!j.ok;
      }catch(e){
        return false;
      }
    }

    // ===== Migrate legacy localStorage → server (one-time) =====
    async function migrateLegacy(){
      const u = getUser(); if(!u) return;
      const legacy = getLocalTx();
      if(!legacy.length) return;

      const items = legacy.map(t => ({
        id: t.id || undefined,
        type: t.type,
        amount: Math.abs(Number(t.amount||0)),
        detail: t.detail || '',
        status: t.status || (t.type==='Withdrawal' ? 'Requested' : 'Pending'),
        ts: Number(t.ts || Date.now())
      }));

      try{
        const r = await fetch('/api/tx/migrate', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ phone: u.phone, items })
        });
        const j = await r.json().catch(()=>({ok:false}));
        if(j.ok){ clearLocalTx(); }
      }catch(_){}
    }

    function renderTx(list){
      txCount.textContent = list.length;
      txTable.innerHTML = list.length ? list.map(t => {
        const amt = Math.abs(Number(t.amount||0));
        const signed = t.type === 'Withdrawal' ? `-${fmt(amt)}` : fmt(amt);
        return `
          <tr>
            <td class="mono">${new Date(t.ts).toLocaleString()}</td>
            <td>${t.type}</td>
            <td>${t.detail||'-'}</td>
            <td style="text-align:right">${signed}</td>
            <td>${t.status||'-'}</td>
          </tr>`;
      }).join('') : `<tr><td colspan="5" class="muted" style="text-align:center">No transactions yet.</td></tr>`;
    }

    // ===== Withdraw (post first; no client-side deduction) =====
    document.getElementById('showWithdraw').onclick = ()=>{
      const c = document.getElementById('withdrawCard');
      c.style.display = c.style.display==='none' ? 'block' : 'none';
    };

    document.getElementById('doWithdraw').onclick = async ()=>{
      const p = wPhone.value.trim(), a = Number(wAmt.value||0), h = wHint;
      const u = getUser() || {wallet:0};
      if(!phoneOk(p)){ h.textContent='Enter a valid M-Pesa number.'; return; }
      if(a<=0){ h.textContent='Enter amount.'; return; }
      if(a > (u.wallet||0)){ h.textContent='Insufficient wallet balance.'; return; }

      const ok = await createServerTx({
        phone: u.phone,
        type: 'Withdrawal',
        amount: Math.abs(a),
        detail: `To ${p}`,
        status: 'Pending'
      });

      if(ok){
        h.textContent='Withdrawal request submitted.';
        wAmt.value='';
      }else{
        h.textContent='Failed to submit. Try again.';
      }
    };

    // ===== Loan Eligibility calculator (3× shares, min loan 20k, 10%/3mo) =====
    const eligInput = document.getElementById('eligShares');
    const eligOut   = document.getElementById('eligOut');

    function computeEligibility(){
      const shares = Number(eligInput?.value || 0);
      const eligible = Math.floor(shares * 3);
      const MIN = 20000;
      if (!eligInput) return;

      if (!shares){
        eligOut.innerHTML = 'Enter your current Shares to see eligibility.';
        return;
      }
      if (eligible < MIN){
        const need = MIN - eligible;
        eligOut.innerHTML = `Below minimum. Add <strong>KES ${fmt(need)}</strong> more in Shares to qualify for <span class="ok-strong">KES ${fmt(MIN)}</span>.`;
        return;
      }
      const totalRepay = Math.round(eligible * 1.10);
      const monthly = Math.ceil(totalRepay / 3);
      eligOut.innerHTML = `
        Eligible amount: <span class="ok-strong">KES ${fmt(eligible)}</span><br>
        Total repay (3 months @10%): <strong>KES ${fmt(totalRepay)}</strong><br>
        Monthly installment (~3x): <strong>KES ${fmt(monthly)}</strong>
      `;
    }
    if (eligInput){ eligInput.addEventListener('input', computeEligibility); }

    // ===== Quick Investment Calculator =====
    const planEl = document.getElementById('plan');
    const amtEl  = document.getElementById('amt');
    const out    = document.getElementById('out');
    const startBtn = document.getElementById('startBtn');

    const PLANS = {
      std:  { name:'Standard',  pct:30, min:1000,   max:70000 },
      gold: { name:'Gold',      pct:50, min:70001,  max:140000 },
      plat: { name:'Platinum',  pct:70, min:140001, max:Infinity }
    };

    function syncPlanUI(){
      if(!planEl || !amtEl) return;
      const p = PLANS[planEl.value];
      amtEl.min = p.min;
      if (isFinite(p.max)) { amtEl.max = p.max; } else { amtEl.removeAttribute('max'); }
      amtEl.placeholder = `Enter amount (${p.min.toLocaleString('en-KE')}${isFinite(p.max)?' – '+p.max.toLocaleString('en-KE'): ' and above'})`;
      if(out) out.textContent = '';
    }
    planEl?.addEventListener('change', syncPlanUI);
    syncPlanUI();

    function validateAmount(){
      const p = PLANS[planEl.value];
      const amt = Number(amtEl.value || 0);
      if(!amt || amt < p.min) { out.textContent = `Minimum for ${p.name} is KES ${p.min.toLocaleString('en-KE')}.`; return null; }
      if(isFinite(p.max) && amt > p.max){ out.textContent = `Maximum for ${p.name} is KES ${p.max.toLocaleString('en-KE')}.`; return null; }
      return {plan:p, amt};
    }

    document.getElementById('calc')?.addEventListener('click', ()=>{
      const v = validateAmount(); if(!v) return;
      const earn = Math.round(v.amt * v.plan.pct / 100);
      out.innerHTML = `Projected earnings in 24h: <strong style="color:var(--ok)">KES ${fmt(earn)}</strong> • Total: <strong>KES ${fmt(v.amt+earn)}</strong>`;
    });

    startBtn?.addEventListener('click', async (e)=>{
      const v = validateAmount();
      if(!v){ e.preventDefault(); return; }
      const me = getUser();

      await createServerTx({
        phone: me.phone,
        type: 'Deposit',
        amount: v.amt,
        detail: `Start ${v.plan.name} (${v.plan.pct}% in 24h) — user heading to /deposit.html`,
        status: 'Pending'
      });
    });

    // ===== Logout → Home =====
    document.getElementById('logoutBtn').onclick = ()=>{
      localStorage.removeItem('imarika_user');
      window.location.href = '/';
    };

    // ===== Gate + boot =====
    const user = getUser();
    if(!user){
      // Keep same behavior — require account first
      window.location.replace('/account.html');
    } else {
      showHeader(user);
      // Prefill eligibility with local shares immediately
      const es = document.getElementById('eligShares');
      if (es) { es.value = Number(user.invested||0); computeEligibility(); }

      // Migrate + refresh
      (async ()=>{
        await migrateLegacy();
        await fetchServerTx();
        await fetchUser();
      })();
    }

    // ===== Tabs =====
    const btns = Array.from(document.querySelectorAll('.tab-btn'));
    const screens = {
      home: document.getElementById('screen-home'),
      invest: document.getElementById('screen-invest'),
      activity: document.getElementById('screen-activity'),
      more: document.getElementById('screen-more')
    };
    function activate(which){
      Object.values(screens).forEach(el=> el.classList.remove('active'));
      btns.forEach(b=> b.classList.remove('active'));
      screens[which].classList.add('active');
      const btn = btns.find(b=>b.dataset.target===which);
      btn?.classList.add('active');
    }
    btns.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.target)));
  </script>
</body>
</html>
