<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Imarika Admin</title>
<link rel="icon" href="/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#fff;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--brand:#f59e0b;--ring:rgba(245,158,11,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1100px;margin:32px auto;padding:0 16px}
  .card{border:1px solid var(--line);border-radius:16px;padding:16px;margin:14px 0;background:#fff;box-shadow:0 10px 30px rgba(2,8,23,.06)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(245,158,11,.25)}
  .btn-outline{background:#fff;border:1px solid var(--line)}
  .btn-slim{padding:.55rem .8rem;border-radius:10px}
  .muted{color:var(--muted)}
  input{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px;outline:none}
  input:focus{box-shadow:0 0 0 4px var(--ring)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--line);padding:.6rem .7rem;vertical-align:top}
  th{background:#fff7ed}
  .badge{padding:.18rem .5rem;border-radius:999px;background:#fef3c7;color:#78350f;font-weight:800}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  a.back{display:inline-flex;align-items:center;gap:8px}
  .logo{height:24px;width:24px;border-radius:6px}
  footer{border-top:1px solid var(--line);padding:2.2rem 0;color:#475569;margin-top:2rem}
</style>

<body>
  <div class="container">
    <div class="topbar">
      <a class="back" href="/"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#0f172a" stroke-width="2"/></svg>Back</a>
      <div class="row">
        <img src="/favicon.svg" class="logo" alt="">
        <strong>Imarika Admin</strong>
        <span id="who" class="muted"></span>
        <button class="btn btn-outline btn-slim" id="logout" style="display:none">Logout</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card" style="display:none">
      <div class="row">
        <input id="adPhone" placeholder="Admin phone" value="0715151010" class="mono" style="max-width:220px">
        <input id="adPass" type="password" placeholder="Password" style="max-width:220px">
        <button class="btn" id="adLogin">Login</button>
        <span id="adHint" class="muted"></span>
      </div>
    </div>

    <!-- Users list -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Users</h2>
        <div class="row">
          <span class="badge" id="userCount">0</span>
          <input id="uSearch" placeholder="Search name / phone / account" style="min-width:220px">
          <button class="btn btn-outline btn-slim" id="refreshUsers">Refresh</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table id="usersTable">
          <thead><tr><th>Name</th><th>Phone</th><th style="text-align:right">Wallet</th><th style="text-align:right">Shares</th><th>Created</th></tr></thead>
          <tbody><tr><td colspan="5" class="muted" style="text-align:center">—</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Find / Create -->
    <div class="card">
      <h2>Find / Create</h2>
      <div class="grid2">
        <input id="qPhone" placeholder="Phone (07/01… 10 digits)" inputmode="tel" class="mono">
        <input id="qAcct" placeholder="Account (IMK-....-....)" class="mono">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn btn-outline" id="newBtn">Create New</button>
        <span class="muted" id="hint"></span>
      </div>
    </div>

    <!-- Edit user -->
    <div id="editCard" class="card" style="display:none">
      <h2>Edit User</h2>
      <div class="grid2">
        <div><div class="muted">Full Name</div><input id="eName" placeholder="(optional)"></div>
        <div><div class="muted">Phone</div><input id="ePhone" class="mono" readonly></div>
        <div><div class="muted">ID Number</div><input id="eId" class="mono" placeholder="(optional)"></div>
        <div><div class="muted">Account</div><input id="eAcct" class="mono" readonly></div>
      </div>
      <h3 style="margin-top:10px">Balances</h3>
      <div class="grid2">
        <div><div class="muted">Wallet (KES)</div><input id="eWallet" type="number" placeholder="0"></div>
        <div><div class="muted">Shares (KES)</div><input id="eInvest" type="number" placeholder="0"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn btn-outline" id="closeBtn">Close</button>
        <span class="muted" id="saveHint"></span>
      </div>
    </div>

    <!-- Pending -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Pending Transactions</h2>
        <div class="row">
          <span class="badge" id="pendCount">0</span>
          <button class="btn btn-outline btn-slim" id="refreshPend">Refresh</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table id="pendTable">
          <thead><tr><th>Date</th><th>Phone</th><th>Type</th><th>Details</th><th style="text-align:right">Amount (KES)</th><th>Actions</th></tr></thead>
          <tbody><tr><td colspan="6" class="muted" style="text-align:center">—</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap">
      <div class="row">
        <img src="/favicon.svg" class="logo" alt="">
        <span>© <span id="y"></span> Imarika — <a class="muted" href="https://imarika.net">imarika.net</a></span>
      </div>
      <div class="row">
        <span class="muted">Payments Accepted:&nbsp;</span>
        <img src="/mpesa.png" alt="M-Pesa" style="height:60px;width:auto;vertical-align:middle">
        <span class="muted">·</span>
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true"><path fill="#334155" d="M3 10.5 12 5l9 5.5v7A1.5 1.5 0 0 1 19.5 19h-15A1.5 1.5 0 0 1 3 17.5z"/><path fill="#94a3b8" d="M12 7.2 5 11v6.5h14V11z"/></svg>
        <strong>Bank Transfer</strong>
      </div>
    </div>
  </footer>

  <script>
    const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();
    const fmt = n => Number(n||0).toLocaleString('en-KE');
    const tokenKey = 'imarika_admin_token';

    function setLoggedInUI(tip){ document.getElementById('who').textContent = tip; document.getElementById('logout').style.display = tip ? 'inline-flex' : 'none'; }
    async function authedFetch(url, opts={}){ const t = localStorage.getItem(tokenKey)||''; opts.headers = Object.assign({}, opts.headers||{}, {'authorization':'Bearer '+t}); return fetch(url, opts); }

    // Login / Logout
    const adLogin = document.getElementById('adLogin'), adPhone = document.getElementById('adPhone'), adPass = document.getElementById('adPass'), adHint = document.getElementById('adHint'), logoutBtn = document.getElementById('logout');
    adLogin.onclick = async ()=>{
      adHint.textContent='Signing in...';
      const r = await fetch('/api/admin/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({phone:adPhone.value.trim(),pass:adPass.value})});
      const j = await r.json().catch(()=>({}));
      if(j.ok){ localStorage.setItem(tokenKey,j.token); setLoggedInUI(adPhone.value.trim()); document.getElementById('loginCard').style.display='none'; boot(); adHint.textContent=''; }
      else adHint.textContent=j.error||'Login failed';
    };
    logoutBtn.onclick = ()=>{ localStorage.removeItem(tokenKey); setLoggedInUI(''); document.getElementById('loginCard').style.display='block'; usersTableBody.innerHTML='<tr><td colspan="5" class="muted" style="text-align:center">—</td></tr>'; pendTableBody.innerHTML='<tr><td colspan="6" class="muted" style="text-align:center">—</td></tr>'; };

    // Users list
    const userCount=document.getElementById('userCount'), usersTableBody=document.querySelector('#usersTable tbody'), uSearch=document.getElementById('uSearch'), refreshUsers=document.getElementById('refreshUsers');
    async function renderUsers(){
      const q=(uSearch.value||'').trim(); usersTableBody.innerHTML='<tr><td colspan="5" class="muted" style="text-align:center">Loading…</td></tr>';
      const r=await authedFetch('/api/admin/users'+(q?`?search=${encodeURIComponent(q)}`:'')); if(r.status===401){ document.getElementById('loginCard').style.display='block'; setLoggedInUI(''); return;}
      const j=await r.json().catch(()=>({})); if(!j.ok){ usersTableBody.innerHTML=`<tr><td colspan="5" class="muted" style="text-align:center">${j.error||'Failed'}</td></tr>`; return;}
      const list=j.users||[]; userCount.textContent=list.length;
      usersTableBody.innerHTML=list.length?list.map(u=>`
        <tr>
          <td>${u.full_name||'(no name)'}</td>
          <td class="mono">${u.phone}</td>
          <td style="text-align:right">${fmt(u.wallet)}</td>
          <td style="text-align:right">${fmt(u.invested)}</td>
          <td class="mono">${u.created_at?new Date((u.created_at||0)*1000).toLocaleString():'-'}</td>
        </tr>
      `).join(''):`<tr><td colspan="5" class="muted" style="text-align:center">No users</td></tr>`;
    }
    let uTimer=null; uSearch.addEventListener('input',()=>{clearTimeout(uTimer);uTimer=setTimeout(renderUsers,300)}); refreshUsers.onclick=renderUsers;

    // Pending
    const pendCount=document.getElementById('pendCount'), pendTableBody=document.querySelector('#pendTable tbody'), refreshPend=document.getElementById('refreshPend');
    async function renderPending(){
      pendTableBody.innerHTML='<tr><td colspan="6" class="muted" style="text-align:center">Loading…</td></tr>';
      const r=await authedFetch('/api/admin/pending'); if(r.status===401){ document.getElementById('loginCard').style.display='block'; setLoggedInUI(''); return;}
      const j=await r.json().catch(()=>({})); if(!j.ok){ pendTableBody.innerHTML=`<tr><td colspan="6" class="muted" style="text-align:center">${j.error||'Failed'}</td></tr>`; return;}
      const rows=j.pending||[]; pendCount.textContent=rows.length;
      pendTableBody.innerHTML=rows.length?rows.map(t=>`
        <tr>
          <td class="mono">${new Date(t.ts).toLocaleString()}</td>
          <td class="mono">${t.phone||'-'}</td>
          <td>${t.type}</td>
          <td>${t.detail||'-'}</td>
          <td style="text-align:right">${(t.amount<0?'-':'')}${fmt(Math.abs(t.amount||0))}</td>
          <td class="row">
            <button class="btn btn-slim" data-approve="${t.id}">Approve</button>
            <button class="btn btn-outline btn-slim" data-reject="${t.id}">Reject</button>
          </td>
        </tr>
      `).join(''):`<tr><td colspan="6" class="muted" style="text-align:center">No pending items.</td></tr>`;
      pendTableBody.querySelectorAll('button[data-approve]').forEach(b=> b.onclick=()=>updateTx(b.dataset.approve,'approve'));
      pendTableBody.querySelectorAll('button[data-reject]').forEach(b=> b.onclick=()=>updateTx(b.dataset.reject,'reject'));
    }
    async function updateTx(id,action){
      const r=await authedFetch('/api/admin/tx/update',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({id,action})});
      const j=await r.json().catch(()=>({})); if(!j.ok){ alert(j.error||'Failed'); return;} renderPending(); renderUsers();
    }
    refreshPend.onclick=renderPending;

    // Find / Create / Edit
    const qPhone=document.getElementById('qPhone'), qAcct=document.getElementById('qAcct'), hint=document.getElementById('hint');
    const editCard=document.getElementById('editCard'), eName=document.getElementById('eName'), ePhone=document.getElementById('ePhone'), eId=document.getElementById('eId'), eAcct=document.getElementById('eAcct'), eWallet=document.getElementById('eWallet'), eInvest=document.getElementById('eInvest'), saveHint=document.getElementById('saveHint');
    function fillEdit(u){ eName.value=u.full_name||''; ePhone.value=u.phone||''; eId.value=u.id_number||''; eAcct.value=u.account||''; eWallet.value=u.wallet||0; eInvest.value=u.invested||0; editCard.style.display='block'; }

    document.getElementById('searchBtn').onclick = async ()=>{
      hint.textContent=''; const p=qPhone.value.trim(), a=qAcct.value.trim();
      if(!p && !a){ hint.textContent='Provide phone or account.'; return; }
      const r=await authedFetch('/api/admin/user'+(p?`?phone=${encodeURIComponent(p)}`:`?account=${encodeURIComponent(a)}`));
      const j=await r.json().catch(()=>({})); if(!j.ok){ hint.textContent=j.error||'Not found'; editCard.style.display='none'; return;}
      fillEdit(j.user); saveHint.textContent='';
    };

    document.getElementById('newBtn').onclick = async ()=>{
      hint.textContent=''; const p=qPhone.value.trim(); if(!/^0(7|1)\d{8}$/.test(p)){ hint.textContent='Enter valid phone (07/01… 10 digits).'; return; }
      const r=await authedFetch('/api/admin/user/upsert',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({phone:p})});
      const j=await r.json().catch(()=>({})); if(!j.ok){ hint.textContent=j.error||'Failed'; return;}
      fillEdit(j.user); saveHint.textContent='Created.';
      renderUsers();
    };

    document.getElementById('saveBtn').onclick = async ()=>{
      const payload={ phone:ePhone.value.trim(), full_name:eName.value.trim()||null, id_number:eId.value.trim()||null, wallet:Number(eWallet.value||0), invested:Number(eInvest.value||0) };
      const r=await authedFetch('/api/admin/user/upsert',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json().catch(()=>({})); if(!j.ok){ saveHint.textContent=j.error||'Failed'; return; }
      saveHint.textContent='Saved.'; renderUsers();
    };
    document.getElementById('closeBtn').onclick = ()=>{ editCard.style.display='none'; saveHint.textContent=''; };

    // Boot
    async function boot(){ await Promise.all([renderUsers(), renderPending()]); }
    (function start(){ if(localStorage.getItem('imarika_admin_token')){ setLoggedInUI('(signed in)'); document.getElementById('loginCard').style.display='none'; boot(); } else { document.getElementById('loginCard').style.display='block'; } })();
  </script>
</body>
</html>
