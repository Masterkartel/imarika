<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Account | Imarika</title>
<link rel="icon" href="/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#fff;--text:#0f172a;--muted:#475569;--line:#e5e7eb;--card:#fff;
    --brand:#f59e0b;--ring:rgba(245,158,11,.35)
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{text-decoration:none;color:inherit}
  .container{max-width:920px;margin:0 auto;padding:0 1rem}
  header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:40}
  .brand{display:flex;align-items:center;gap:.55rem;height:64px}
  .logo{height:32px;width:32px;border-radius:10px}

  .card{background:#fff;border:1px solid var(--line);border-radius:18px;padding:1.15rem;box-shadow:0 10px 30px rgba(2,8,23,.06)}
  .stack{display:grid;gap:1rem;max-width:560px;margin:1rem 0}

  input{width:100%;padding:.85rem;border:1px solid var(--line);border-radius:14px;outline:none}
  input:focus{border-color:#cbd5e1;box-shadow:0 0 0 4px var(--ring)}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:.8rem 1rem;border-radius:14px;font-weight:700;background:var(--brand);color:#111827;border:0;cursor:pointer;box-shadow:0 10px 30px rgba(245,158,11,.25)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn-outline{background:#fff;border:1px solid var(--line)}
  .muted{color:var(--muted)}

  .input-wrap{position:relative}
  .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:0;background:transparent;cursor:pointer;padding:6px;border-radius:8px}
  .eye:focus{outline:2px solid var(--ring)}
  .inline-note{font-size:.9rem;color:#64748b;margin-top:-.3rem}

  .tabs{display:inline-flex;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#fff}
  .tab{padding:.5rem 1rem;border:0;background:#fff;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand)}
  .tab:focus{outline:2px solid var(--ring)}

  footer{border-top:1px solid var(--line);padding:2.2rem 0;color:#475569;margin-top:2rem}
</style>

<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between">
      <a class="brand" href="/"><img src="/favicon.svg" class="logo" alt=""><strong>Imarika</strong></a>
      <a class="btn-outline" style="padding:.55rem .8rem;border-radius:12px" href="/">← Home</a>
    </div>
  </header>

  <section>
    <div class="container">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-top:1rem">
        <div>
          <h1 style="margin:.5rem 0 .25rem">Welcome</h1>
          <p class="muted" style="margin:0">Login or create an account to access your dashboard.</p>
        </div>

        <div class="tabs" role="tablist" aria-label="Auth switch">
          <button id="tabLogin"  class="tab active" role="tab" aria-selected="true"  aria-controls="loginCard">Login</button>
          <button id="tabCreate" class="tab"        role="tab" aria-selected="false" aria-controls="createCard">Create account</button>
        </div>
      </div>

      <div class="stack">
        <!-- LOGIN -->
        <form id="loginCard" class="card" onsubmit="return false;" style="display:grid;gap:.6rem">
          <h3>Login</h3>
          <input id="lPhone" inputmode="tel" placeholder="Phone (07/01… 10 digits)" required autofocus>
          <div class="input-wrap">
            <input id="lPIN" type="password" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="4-digit PIN" required>
            <button class="eye" type="button" aria-label="Show/Hide PIN" id="lEye">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="#334155" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="#334155" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <button class="btn" id="lBtn">Login</button>
          <div class="muted" id="lHint" aria-live="polite"></div>
          <div class="muted" style="font-size:.9rem">No account? <a href="#" id="toCreate"><strong>Create one</strong></a></div>
        </form>

        <!-- CREATE -->
        <form id="createCard" class="card" onsubmit="return false;" style="display:none;gap:.6rem">
          <h3>Create Account</h3>
          <input id="sFull" placeholder="Full Name (First Middle Last)" required>
          <input id="sId" inputmode="numeric" placeholder="ID Number *" required>
          <input id="sPhone" inputmode="tel" placeholder="Phone * (07/01… 10 digits)" required>

          <div class="input-wrap">
            <input id="sPIN" type="password" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="4-digit PIN *" required>
            <button class="eye" type="button" aria-label="Show/Hide PIN" id="sEye">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="#334155" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="#334155" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="input-wrap">
            <input id="sPIN2" type="password" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="Confirm PIN *" required>
            <button class="eye" type="button" aria-label="Show/Hide PIN" id="sEye2">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="#334155" stroke-width="2"/>
                <circle cx="12" cy="12" r="3" stroke="#334155" stroke-width="2"/>
              </svg>
            </button>
          </div>
          <div class="inline-note">Tip: PIN must be exactly 4 digits.</div>

          <button class="btn" id="sBtn">Create Account</button>
          <div class="muted" id="sHint" aria-live="polite"></div>
          <div class="muted" style="font-size:.9rem">Already have an account? <a href="#" id="toLogin"><strong>Login</strong></a></div>
        </form>
      </div>
    </div>
  </section>

  <footer>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:.6rem">
        <img src="/favicon.svg" class="logo" alt="">
        <span>© <span id="y"></span> Imarika — <a class="muted" href="https://imarika.net">imarika.net</a></span>
      </div>
      <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
        <span class="muted">Payments Accepted:&nbsp;</span>
        <img src="/mpesa.png" alt="M-Pesa" style="height:60px;width:auto;vertical-align:middle">
        <span class="muted">·</span>
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true"><path fill="#334155" d="M3 10.5 12 5l9 5.5v7A1.5 1.5 0 0 1 19.5 19h-15A1.5 1.5 0 0 1 3 17.5z"/><path fill="#94a3b8" d="M12 7.2 5 11v6.5h14V11z"/></svg>
        <strong>Bank Transfer</strong>
      </div>
    </div>
  </footer>

  <script>
    // Footer year
    const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();

    // Utilities
    const phoneOk   = p => /^0(7|1)\d{8}$/.test(String(p||'').trim());
    const onlyDigits= s => String(s||'').replace(/\D+/g,'');
    const acctNum   = () => 'IMK-' + Math.random().toString(36).slice(2,6).toUpperCase() + '-' + Math.floor(Math.random()*9000+1000);
    const saveUser  = u => localStorage.setItem('imarika_user', JSON.stringify(u));
    const getUser   = () => { try { return JSON.parse(localStorage.getItem('imarika_user')||'null'); } catch { return null; } };

    if (getUser()) window.location.replace('/dashboard');

    // Tabs
    const tabLogin  = document.getElementById('tabLogin');
    const tabCreate = document.getElementById('tabCreate');
    const loginCard  = document.getElementById('loginCard');
    const createCard = document.getElementById('createCard');
    function showLogin(){ tabLogin.classList.add('active'); tabLogin.setAttribute('aria-selected','true'); tabCreate.classList.remove('active'); tabCreate.setAttribute('aria-selected','false'); loginCard.style.display='grid'; createCard.style.display='none'; document.getElementById('lPhone').focus(); }
    function showCreate(){ tabCreate.classList.add('active'); tabCreate.setAttribute('aria-selected','true'); tabLogin.classList.remove('active'); tabLogin.setAttribute('aria-selected','false'); createCard.style.display='grid'; loginCard.style.display='none'; document.getElementById('sFull').focus(); }
    tabLogin.onclick = showLogin; tabCreate.onclick = showCreate;
    document.getElementById('toCreate').onclick = (e)=>{ e.preventDefault(); showCreate(); };
    document.getElementById('toLogin').onclick  = (e)=>{ e.preventDefault(); showLogin(); };

    // Eye + numeric
    function bindEye(inputId, btnId){
      const inp = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      inp.addEventListener('input', ()=>{ inp.value = onlyDigits(inp.value).slice(0,4); });
      btn.onclick = ()=>{ inp.type = (inp.type === 'password') ? 'text' : 'password'; };
    }
    bindEye('sPIN','sEye'); bindEye('sPIN2','sEye2'); bindEye('lPIN','lEye');

    // -------- Create Account (calls /api/register WITH pin) ----------
    const sHint = document.getElementById('sHint');
    const sBtn  = document.getElementById('sBtn');
    sBtn.onclick = async () => {
      const full  = document.getElementById('sFull').value.trim();
      const idn   = document.getElementById('sId').value.trim();
      const phone = document.getElementById('sPhone').value.trim();
      const pin   = document.getElementById('sPIN').value.trim();
      const pin2  = document.getElementById('sPIN2').value.trim();
      sHint.textContent='';

      if(!full || !idn){ sHint.textContent='Name and ID are required.'; return; }
      if(!phoneOk(phone)){ sHint.textContent='Phone must start with 07/01 and be 10 digits.'; return; }
      if(pin.length !== 4 || /\D/.test(pin)){ sHint.textContent='PIN must be exactly 4 digits.'; return; }
      if(pin !== pin2){ sHint.textContent='PINs do not match.'; return; }

      sBtn.disabled = true;
      try{
        // IMPORTANT: send the PIN to server so it’s saved in D1
        const r = await fetch('/api/register', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ phone, full_name: full, id_number: idn, pin })
        });
        const j = await r.json().catch(()=>null);

        if(j && j.ok && j.user){
          const u = j.user;
          saveUser({
            full: u.full_name ?? full,
            idn:  u.id_number ?? idn,
            phone: u.phone ?? phone,
            pinHash: btoa(pin),                 // local convenience only
            account: u.account ?? acctNum(),
            wallet:  u.wallet ?? 0,
            invested:u.invested ?? 0,
            createdAt: u.created_at ? (u.created_at*1000) : Date.now()
          });
          window.location.href = '/dashboard';
          return;
        }

        // fallback (should rarely run)
        sHint.textContent = (j && j.error) ? j.error : 'Could not create account.';
      } catch(e){
        sHint.textContent = 'Network error. Please try again.';
      } finally {
        sBtn.disabled = false;
      }
    };

    // -------- Login (calls /api/login so it persists after logout) ----------
    const lHint = document.getElementById('lHint');
    const lBtn  = document.getElementById('lBtn');
    lBtn.onclick = async () => {
      const phone = document.getElementById('lPhone').value.trim();
      const pin   = document.getElementById('lPIN').value.trim();
      lHint.textContent='';

      if(!phoneOk(phone)){ lHint.textContent='Enter a valid phone.'; return; }
      if(pin.length !== 4){ lHint.textContent='PIN must be 4 digits.'; return; }

      lBtn.disabled = true;
      try{
        const r = await fetch('/api/login', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ phone, pin })
        });
        const j = await r.json().catch(()=>null);

        if(j && j.ok && j.user){
          const u = j.user;
          saveUser({
            full: u.full_name || '',
            idn:  u.id_number || '',
            phone: u.phone,
            pinHash: btoa(pin),
            account: u.account,
            wallet:  u.wallet || 0,
            invested:u.invested || 0,
            createdAt: u.created_at ? (u.created_at*1000) : Date.now()
          });
          window.location.href = '/dashboard';
          return;
        }

        // if server says no, fall back to local-only check (optional)
        const local = getUser();
        if(local && local.phone === phone && local.pinHash === btoa(pin)){
          window.location.href = '/dashboard';
          return;
        }

        lHint.textContent = (j && j.error) ? j.error : 'Login failed.';
      } catch(e){
        lHint.textContent = 'Network error. Please try again.';
      } finally {
        lBtn.disabled = false;
      }
    };

    // Enter-to-submit
    document.getElementById('lPIN').addEventListener('keydown',e=>{ if(e.key==='Enter') lBtn.click(); });
    document.getElementById('sPIN2').addEventListener('keydown',e=>{ if(e.key==='Enter') sBtn.click(); });
  </script>
</body>
</html>
